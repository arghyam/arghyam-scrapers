<!DOCTYPE html><html lang="en">
<head>
  <title>Nirmal Bharat Abhiyan: trends</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <style>
    body { padding-top: 60px; }
    h2 { font-size: 125%; line-height: 1.25; color: #c0504d; }
    .l0 {
      fill: #fff;
    }
    #chart .l2 {
      opacity: 0;
      pointer-events: none;
      -webkit-transition: all 0.3s ease-out;  /* Chrome 1-25, Safari 3.2+ */
         -moz-transition: all 0.3s ease-out;  /* Firefox 4-15 */
           -o-transition: all 0.3s ease-out;  /* Opera 10.50-12.00 */
              transition: all 0.3s ease-out;  /* Chrome 26, Firefox 16+, IE 10+, Opera 12.50+ */
    }
    .legend { display: none; }
    .drilldown #chart .l1 {
      stroke: none;
      fill: #fff;
    }
    .drilldown #chart .l2 {
      opacity: 1;
      pointer-events: auto;
    }
    .axis path, .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }
    .axis text {
      font-size: 11px;
    }
    .scatter circle {
      opacity: .7;
    }
    .scatter .show {
      opacity: 1;
      stroke: #000;
    }
    .scatter .fade {
      display: none;
    }
  </style>
  <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
</head><body>

<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a id="home" class="brand" href="#">TSC</a>
      <ul class="nav">
        <!-- li><a href="#">About</a></li -->
      </ul>
    </div>
  </div>
</div>

<div id="visual" class="container">
  <h2 id="menu"></h2>
  <h1 id="title"></h1>

  <svg class="legend treemap" data-story="treemap" width="100%" height="30">
    <rect width="100%" height="30" fill="url(#gradient_legend)"/>
    <text x="5%"  y="15" fill="#fff" text-anchor="middle" dominant-baseline="middle">0%</text>
    <text x="35%" y="15" fill="#000" text-anchor="middle" dominant-baseline="middle">50%</text>
    <text x="70%" y="15" fill="#fff" text-anchor="middle" dominant-baseline="middle">100%</text>
    <text x="95%" y="15" fill="#fff" text-anchor="middle" dominant-baseline="middle">200%</text>
    <defs>
      <linearGradient id="gradient_legend">
        <stop offset="5%"  stop-color="#D73027"/>
        <stop offset="37%" stop-color="#FFFFBF"/>
        <stop offset="70%" stop-color="#1A9850"/>
        <stop offset="95%" stop-color="#000000"/>
      </linearGradient>
    </defs>
  </svg>

  <div class="legend scatter" data-story="scatter" width="100%" height="30">
  </div>

  <svg id="chart" width="100%" height="500"></svg>
  <p id="story"></p>
  <p>Source: <a target="_blank" href="http://tsc.gov.in/" id="source"></a></p>
</div>

<div id="about" class="container">
  <h2>Ministry of Water &amp; Sanitation</h2>
  <h1>Nirmal Bharat Abhiyan: Trends</h1>
  <div class="row-fluid">
    <div class="span6">
      <p>Open defecation in rural india remains a problem that perplexes policy makers. The first, government level initiative to tackle it came in the form of the Central Rural Sanitation Programme in 1986. A subsidy driven approach was adopted. This programme morphed to take into account the necessity to educate and empower people to adopt and use toilets - the Total Sanitation Campaign in 1999  and to adopt a panchayat based approach rather than a household based one - the Nirmal Bharat Abhiyan in 2012. The scheme was allotted Rs. 3500 crores in 2012-13 budget (before revision) and around 27 lakh toilets were constructed last year.
      <p>The Ministry of Drinking Water and Sanitation, Government of India, under which this scheme is housed puts out detailed financial and physical progress data. This is supposed to provide anyone who is interested a snapshot of the rural sanitation situation in the country. This was also a large scale attempt to decentralise data collection as districts enter data into the IMIS on the government website directly. What has resulted is a vast collection of cumulative data from 2001 on the status of sanitation, available up to the habitation level.
      <p>This effort by the government to put data proactively on the website must provide much reason to rejoice. However, several concerns remain about the quality of the data that is available. The latest numbers that challenge the MDWS data come from the census, according to which around 3.5 crore toilets are missing.
      <p>Arghyam is a public charitable foundation set up by Rohini Nilekani in 2005 - Safe, sustainable water for all.  One of our key focus areas is looking at government spends on sanitation - from both the qualitative aspects of data that is present on the website and also the implementation of  the government's scheme.
      <p>To answer questions about data, Arghyam is collaborating with Gramener. The aim of this collaboration is to understand the sanitation data better & help open up the data actually.
      <p>As a first step we are taking data off of the website and analysing it to understand it better. These analyses - as stories accompanied by visualisations will be uploaded periodically here.
    </div>
    <div class="span6" id="about-entry"></div>
  </div>
</div>

<script src="js/jquery.min.js"></script>
<script src="js/underscore-min.js"></script>
<script src="js/d3.v2.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="stories.js"></script>
<script>
// Clicking on the home button...
d3.select('#visual').style('display', 'none');
d3.select('#home').on('click', function() {
  d3.event.preventDefault();
  d3.select('#visual').style('display', 'none');
  d3.select('#about').style('display', 'block');
})

// Display the menus
var menu = d3.nest().key(function(d) { return d.menu; }).entries(stories);
var parentmenu = d3.select('ul.nav')
  .selectAll('li.dropdown')
    .data(menu)
  .enter()
    .append('li')
    .classed('dropdown', true);

parentmenu
  .append('a')
  .attr('href', '#')
  .classed('dropdown-toggle', true)
  .attr('data-toggle', 'dropdown')
  .text(function(d) { return d.key + ' '; })
      .append('b')
      .classed('caret', true);

parentmenu
  .append('ul')
  .classed('dropdown-menu', true)
  .selectAll('li')
      .data(function(d) { return d.values; })
    .enter()
      .append('li')
        .append('a')
        .attr('href', '#')
        .text(function(d) { return d.title; })
        .on('click', draw)

// Create the menu on #about as well
d3.select('#about-entry').append('ul')
  .selectAll('li')
    .data(menu)
  .enter()
    .append('li')
    .text(function(d) { return d.key; })
    .append('ul')
    .selectAll('li')
        .data(function(d) { return d.values; })
      .enter()
        .append('li')
        .append('a')
        .attr('href', '#')
        .text(function(d) { return d.title; })
        .on('click', draw);

var svg = d3.select('#chart')
    .on('click', function() {
      var drilldown = d3.select('#visual').classed('drilldown');
      d3.select('#visual').classed('drilldown', !drilldown);
    });


// When any menu option is clicked, draw it.
function draw(story) {
  d3.event.preventDefault();

  d3.select('#about').style('display', 'none')
  d3.select('#visual').style('display', 'block');

  // Set the title and story
  d3.select('#menu').text(story.menu);
  d3.select('#title').text(story.title);
  d3.select('#story').text(story.story);
  d3.select('#source').attr('href', story.url).text(story.url);

  window['draw_' + story.type](story);
}

function draw_treemap(story) {
  // Filter the data
  d3.csv(story.file, function(data) {
    var subset = initchart(story, data);
    window.subset = subset;

    var treemap = d3.layout.treemap()
      .size([parseInt(svg.style('width')), svg.attr('height')])
      .sticky(true)
      .children(function(d) { return d.values; })
      .padding(1.5)
      .value(story.size);

    var nodes = d3.nest();
    story.group.forEach(function(group) {
      nodes = nodes.key(function(d) { return d[group]})
    });
    window.nodes = nodes.entries(subset);

    treemap.nodes({
      'key': 'India',
      'values': nodes.entries(subset)
    });

    var node = svg.selectAll('rect')
      .data(treemap.nodes)
      .call(position)
      .attr('fill', story.color)
    node.select('title')
      .text(story.hover);
    node.enter().append('rect')
      .call(position)
      .attr('fill', story.color)
      .append('title')
        .text(story.hover);
    node.exit().remove();
  });
}


function draw_scatter(story) {
  // Filter the data
  d3.csv(story.file, function(data) {
    var subset = initchart(story, data);

    // TODO: Make these move
    svg.selectAll('*').remove();

    var width = parseInt(svg.style('width'));
    var height = svg.attr('height');
    var node = svg.selectAll('circle')
      .data(subset);
    var rmax = _.max(_.map(subset, story.area[1]));

    // Set up the legend
    var legend = d3.select('.legend.scatter');
    legend.selectAll('*').remove();
    var select = legend.append('select');
    var groups = _.uniq(_.pluck(data, story.group[0]));
    groups.unshift('')
    select.selectAll('option')
        .data(groups)
      .enter()
        .append('option')
        .text(function(d) { return d; });
    select.on('change', function() {
      var group = d3.select(this).property('value');
      svg.selectAll('circle').classed('fade', true);
      svg.selectAll('circle[data-q="' + group + '"]').classed('fade', false).classed('show', true);
    });

    var R = story.R;
    var xscale = d3.scale.linear().range([R, width - R]);
    var yscale = d3.scale.linear().range([height - R, R]);
    node.enter().append('circle')
      .attr('cx', function(d) { return xscale(story.cx(d)); })
      .attr('cy', function(d) { return yscale(story.cy(d)); })
      .attr('r', function(d) { return R * story.area[1](d) / rmax; })
      .attr('fill', story.color)
      .attr('stroke', '#aaf')
      .attr('data-q', function(d) { return d[story.group[0]]; })
      .on('mouseover', function() {
        var q = d3.select(this).attr('data-q');
        svg.selectAll('.show').classed('show', false);
        svg.selectAll('circle[data-q="' + q + '"]').classed('show', true);
      })
      .on('mouseout', function() {
        svg.selectAll('.show').classed('show', false);
      })
      .on('click', function() {
        var hidden = svg.selectAll('.fade');
        if (hidden[0].length) {
          hidden.classed('fade', false);
          select.property('value', '');
        } else {
          var q = d3.select(this).attr('data-q');
          svg.selectAll('circle').classed('fade', true);
          svg.selectAll('circle[data-q="' + q + '"]')
            .classed('fade', false)
            .classed('show', true);
          select.property('value', q);
        }
      })
      .append('title')
        .text(story.hover)

    var xaxis = svg.append('g')
      .classed('axis', true)
      .attr('transform', 'translate(0,' + (height - R) + ')')
      .call(d3.svg.axis()
              .scale(xscale)
              .orient('bottom')
              .tickFormat(d3.format('.0%')))
      .append('text')
        .text(story.x[0])
        .attr('transform', 'translate(0, -5)')
        .attr('x', width - R)
        .attr('text-anchor', 'end');

    var yaxis = svg.append('g')
      .attr('class', 'axis')
      .attr('transform', 'translate(' + R + ',0)')
      .call(d3.svg.axis()
              .scale(yscale)
              .orient('left')
              .tickFormat(d3.format('.0%')))
      .append('text')
        .text(story.y[0])
        .attr('x', R)
        .attr('transform', 'translate(5,0) rotate(-90,' + R + ',' + R + ')')
        .attr('text-anchor', 'end')
        .attr('dominant-baseline', 'hanging');

  });
}

function initchart(story, data) {
  // No transitions work for other chart types, so just empty it
  var svgtype = svg.attr('data-type');
  if (svgtype !== story.type) {
    svg.selectAll('*').remove();
    if (svg.attr('data-type')) {
      svg.classed(svgtype, false);
      d3.selectAll('[data-story="' + svgtype + '"]').style('display', null);
    }
    d3.selectAll('[data-story="' + story.type + '"]').style('display', 'block');
    svg.classed(story.type, true)
      .attr('data-type', story.type);
  }

  return _.filter(data, story.filter)
}

function position() {
  this.transition()
    .duration(400)
    .attr('x', function(d) { return d.x; })
    .attr('y', function(d) { return d.y; })
    .attr('width', function(d) { return d.dx; })
    .attr('height', function(d) { return d.dy; })
    .attr('stroke', '#fff')
    .attr('class', function(d) { return "l" + d.depth; })
}

</script>
</body></html>
